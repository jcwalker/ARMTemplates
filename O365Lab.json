{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "adminUsername": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Username for the Virtual Machine."
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the Virtual Machine."
      }
    },
    "vNetName": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Name for virtual network."
      }
    },
    "DC1virtualMachineName": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Name of the Azure VM which will be the domain contorller."
      }
    },
    "windowsOSVersion": {
      "type": "string",
      "defaultValue": "2012-R2-Datacenter",
      "allowedValues": [
        "2008-R2-SP1",
        "2012-Datacenter",
        "2012-R2-Datacenter"
      ],
      "metadata": {
        "description": "The Windows version for the VM. This will pick a fully patched image of this given Windows version. Allowed values: 2008-R2-SP1, 2012-Datacenter, 2012-R2-Datacenter."
      }
    },
    "assetLocation": {
      "type": "string",
      "metadata": {
        "description": "URL to root of DSC scripts and modules"
      }
    },
    "domainName": {
      "type": "string",
      "metadata": {
        "description": "Name of domain to be created"
      }
    },
    "ExchangeOrganizationName": {
      "type": "string",
      "minLength": 1
    },
    "Exchange1Name": {
      "type": "string",
      "minLength": 1
    },
    "Exchange1WindowsOSVersion": {
      "type": "string",
      "defaultValue": "2012-R2-Datacenter",
      "allowedValues": [
        "2008-R2-SP1",
        "2012-Datacenter",
        "2012-R2-Datacenter",
        "Windows-Server-Technical-Preview"
      ]
    },
    "Exchange1PublicIPAddressDnsName": {
      "type": "string",
      "minLength": 1
    },
    "CertPath": {
      "type": "string",
      "metadata": {
        "description": "The file path the cert will be downloaded to"
      }
    },
    "CertUri": {
      "type": "string",
      "metadata": {
        "description": "Specifies the Uri to download the Exchange SSL certificate from"
      }
    },
    "ExchangeCertThumbprint": {
      "type": "string",
      "metadata": {
        "description": "Specifies the thumbprint on the Exchange SSL certificate"
      }
    },
    "ExchangeExternalUrl": {
      "type": "string",
      "metadata": {
        "description": "Specifies external Exchange Url"
      }
    },
    "ExchangeInternalUrl": {
      "type": "string",
      "metadata": {
        "description": "Specifies internal Exchange Url"
      }
    },
    "ExchangeAutoDDnsName": {
      "type": "string",
      "metadata": {
        "description": "Specifies the DNS name use in the autodiscover Uri"
      }
    },
    "SQL1Name": {
      "type": "string",
      "minLength": 1
    },
    "SQL1WindowsOSVersion": {
      "type": "string",
      "defaultValue": "2012-R2-Datacenter",
      "allowedValues": [
        "2008-R2-SP1",
        "2012-Datacenter",
        "2012-R2-Datacenter",
        "Windows-Server-Technical-Preview"
      ]
    },
    "Adfs1Name": {
      "type": "string",
      "minLength": 1
    },
    "AdfsFederationServiceName": {
      "type": "string",
      "metadata": {
        "description": "Specifies the DNS name of the federation service."
      }
    },
    "AdfsFederationServiceDisplayName": {
      "type": "string",
      "metadata": {
        "description": "Specifies the display name of the Federation Service."
      }
    },
    "AdfsServiceAccountName": {
      "type": "string",
      "metadata": {
        "description": "Specifies the name of the ADFS service account."
      }
    },
    "Adfs1WindowsOSVersion": {
      "type": "string",
      "defaultValue": "2012-R2-Datacenter",
      "allowedValues": [
        "2008-R2-SP1",
        "2012-Datacenter",
        "2012-R2-Datacenter",
        "Windows-Server-Technical-Preview"
      ]
    },
    "Wap1Name": {
      "type": "string",
      "minLength": 1
    },
    "Wap1WindowsOSVersion": {
      "type": "string",
      "defaultValue": "2012-R2-Datacenter",
      "allowedValues": [
        "2008-R2-SP1",
        "2012-Datacenter",
        "2012-R2-Datacenter",
        "Windows-Server-Technical-Preview"
      ]
    },
    "Dirsync1Name": {
      "type": "string",
      "minLength": 1
    },
    "Dirsync1WindowsOSVersion": {
      "type": "string",
      "defaultValue": "2012-R2-Datacenter",
      "allowedValues": [
        "2008-R2-SP1",
        "2012-Datacenter",
        "2012-R2-Datacenter",
        "Windows-Server-Technical-Preview"
      ]
    },
    "Wap1publicIPAddressNameDnsName": {
      "type": "string",
      "minLength": 1
    }
  },
  "variables": {
    "accountid": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', variables('diagnosticsStorageAccountResourceGroup'), '/providers/', 'Microsoft.Storage/storageAccounts/', variables('diagnosticsStorageAccountName'))]",
    "addressPrefix": "10.0.0.0/16",
    "adModulesURL": "[concat(parameters('assetLocation'),'FirstDC.ps1.zip')]",
    "exchModulesURL": "[concat(parameters('assetLocation'),'FirstExchangeServerARM.ps1.zip')]",
    "adfsModulesURL": "[concat(parameters('assetLocation'),'InstallAdfsServer.ps1.zip')]",
    "wapModulesURL": "[concat(parameters('assetLocation'), 'InstallWapServer.ps1.zip')]",
    "sqlModulesURL": "[concat(parameters('assetLocation'), 'InstallSql.ps1.zip')]",
    "diagnosticsStorageAccountName": "[variables('vhdStorageName')]",
    "diagnosticsStorageAccountResourceGroup": "[resourcegroup().name]",
    "FirstDCConfigurationFunction": "FirstDC.ps1\\FirstDC",
    "imageOffer": "WindowsServer",
    "imagePublisher": "MicrosoftWindowsServer",
    "DC1nicName": "[concat(variables('DC1vmName'),'-NIC1')]",
    "DC1OSDiskName": "[concat(parameters('DC1virtualMachineName'), '-OS')]",
    "DC1publicIPAddressName": "[concat(parameters('DC1virtualMachineName'), '-PublicIP')]",
    "DC1publicIPAddressType": "Dynamic",
    "subnetName": "Subnet",
    "subnetPrefix": "10.0.0.0/24",
    "subnetRef": "[concat(variables('vnetId'), '/subnets/', variables('subnetName'))]",
    "vhdStorageContainerName": "vhds",
    "vhdStorageName": "[concat('vhdstorage', uniqueString(resourceGroup().id))]",
    "vhdStorageType": "Standard_LRS",
    "virtualNetworkName": "[parameters('vNetName')]",
    "DC1vmName": "[parameters('DC1virtualMachineName')]",
    "DC1vmSize": "Standard_A2",
    "vnetId": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]",
    "Exchange1ImagePublisher": "MicrosoftWindowsServer",
    "Exchange1ImageOffer": "WindowsServer",
    "Exchange1OSDiskName": "Exchange1OSDisk",
    "Exchange1VmSize": "Standard_A4",
    "Exchange1VnetID": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]",
    "Exchange1SubnetRef": "[concat(variables('Exchange1VnetID'), '/subnets/', variables('subnetName'))]",
    "Exchange1StorageAccountContainerName": "vhds",
    "Exchange1NicName": "[concat(parameters('Exchange1Name'), '-NIC1')]",
    "Exchange1PublicIPAddressName": "[concat(parameters('Exchange1Name'), '-PublicIP')]",
    "Exchange1ServerPrivateIP": "10.0.0.5",
    "Adfs1ServerPrivateIP": "10.0.0.6",
    "Wap1ServerPrivateIP": "10.0.0.7",
    "Sql1ServerPrivateIP": "10.0.0.8",
    "Dirsync1ServerPrivateIP": "10.0.0.9",
    "DnsDomainName": "[parameters('domainName')]",
    "FirstExchangeServerARMConfigurationFunction": "FirstExchangeServerARM.ps1\\FirstExchangeServerARM",
    "exchSoftwareSourcePath": "C:\\InstallFiles",
    "SQL1ImagePublisher": "MicrosoftWindowsServer",
    "SQL1ImageOffer": "WindowsServer",
    "SQL1OSDiskName": "SQL1OSDisk",
    "SQL1VmSize": "Standard_DS2_v2",
    "SQL1VnetID": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]",
    "SQL1SubnetRef": "[concat(variables('SQL1VnetID'), '/subnets/', variables('subnetName'))]",
    "SQL1StorageAccountContainerName": "vhds",
    "SQL1NicName": "[concat(parameters('SQL1Name'), '-NIC1')]",
    "Adfs1ImagePublisher": "MicrosoftWindowsServer",
    "Adfs1ImageOffer": "WindowsServer",
    "Adfs1OSDiskName": "Adfs1OSDisk",
    "Adfs1VmSize": "Standard_D1",
    "Adfs1VnetID": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]",
    "Adfs1SubnetRef": "[concat(variables('Adfs1VnetID'), '/subnets/', variables('subnetName'))]",
    "Adfs1StorageAccountContainerName": "vhds",
    "Adfs1NicName": "[concat(parameters('Adfs1Name'), '-NIC')]",
    "Wap1ImagePublisher": "MicrosoftWindowsServer",
    "Wap1ImageOffer": "WindowsServer",
    "Wap1OSDiskName": "Wap1OSDisk",
    "Wap1VmSize": "Standard_D1",
    "Wap1VnetID": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]",
    "Wap1SubnetRef": "[concat(variables('Wap1VnetID'), '/subnets/', variables('subnetName'))]",
    "Wap1StorageAccountContainerName": "vhds",
    "Wap1NicName": "[concat(parameters('Wap1Name'), '-NIC')]",
    "Dirsync1ImagePublisher": "MicrosoftWindowsServer",
    "Dirsync1ImageOffer": "WindowsServer",
    "Dirsync1OSDiskName": "Dirsync1OSDisk",
    "Dirsync1VmSize": "Standard_D1",
    "Dirsync1VnetID": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]",
    "Dirsync1SubnetRef": "[concat(variables('Dirsync1VnetID'), '/subnets/', variables('subnetName'))]",
    "Dirsync1StorageAccountContainerName": "vhds",
    "Dirsync1NicName": "[concat(parameters('Dirsync1Name'), '-NIC')]",
    "Sql1publicIPAddressName": "[concat(parameters('SQL1Name'), '-PublicIP')]",
    "Wap1publicIPAddressName": "[concat(parameters('Wap1Name'), '-PublicIP')]",
    "Adfs1publicIPAddressName": "[concat(parameters('Adfs1Name'), '-PublicIP')]",
    "Dirsync1publicIPAddressName": "[concat(parameters('Dirsync1Name'), '-PublicIP')]",
    "InstallAdfsConfigurationFunction": "InstallAdfsServer.ps1\\InstallAdfsServer",
    "InstallWapConfigurationFunction": "InstallWapServer.ps1\\InstallWapServer",
    "InstallSqlConfigurationFunction": "InstallSql.ps1\\InstallSql"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "name": "[variables('vhdStorageName')]",
      "apiVersion": "2015-06-15",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "StorageAccount"
      },
      "properties": {
        "accountType": "[variables('vhdStorageType')]"
      }
    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[variables('DC1publicIPAddressName')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "DC1PublicIPAddress"
      },
      "properties": {
        "publicIPAllocationMethod": "[variables('DC1publicIPAddressType')]"

      }
    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/virtualNetworks",
      "name": "[variables('virtualNetworkName')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "VirtualNetwork"
      },
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[variables('addressPrefix')]"
          ]
        },
        "dhcpOptions": {
          "dnsServers": [
            "10.0.0.4",
            "168.63.129.16"
          ]
        },
        "subnets": [
          {
            "name": "[variables('subnetName')]",
            "properties": {
              "addressPrefix": "[variables('subnetPrefix')]"
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[variables('DC1nicName')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "DC1NIC"
      },
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', variables('DC1publicIPAddressName'))]",
        "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "privateIPAddress": "10.0.0.4",
              "privateIPAllocationMethod": "Static",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('DC1publicIPAddressName'))]"
              },
              "subnet": {
                "id": "[variables('subnetRef')]"
              }
            }
          }
        ]
      }
    },
    {
      "apiVersion": "2015-06-15",
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[variables('DC1vmName')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "displayName": "DC1"
      },
      "dependsOn": [
        "[concat('Microsoft.Storage/storageAccounts/', variables('vhdStorageName'))]",
        "[concat('Microsoft.Network/networkInterfaces/', variables('DC1nicName'))]"
      ],
      "properties": {
        "hardwareProfile": {
          "vmSize": "[variables('DC1vmSize')]"
        },
        "osProfile": {
          "computerName": "[variables('DC1vmName')]",
          "adminUsername": "[parameters('adminUsername')]",
          "adminPassword": "[parameters('adminPassword')]"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "[variables('imagePublisher')]",
            "offer": "[variables('imageOffer')]",
            "sku": "[parameters('windowsOSVersion')]",
            "version": "latest"
          },
          "osDisk": {
            "name": "osdisk",
            "vhd": {
              "uri": "[concat('http://', variables('vhdStorageName'), '.blob.core.windows.net/', variables('vhdStorageContainerName'), '/', variables('DC1OSDiskName'), '.vhd')]"
            },
            "caching": "ReadWrite",
            "createOption": "FromImage"
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('DC1nicName'))]"
            }
          ]
        },
        "diagnosticsProfile": {
          "bootDiagnostics": {
            "enabled": true,
            "storageUri": "[concat('http://', variables('diagnosticsStorageAccountName'), '.blob.core.windows.net')]"
          }
        }
      },
      "resources": [
        {
          "name": "FirstDC",
          "type": "extensions",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [
            "[concat('Microsoft.Compute/virtualMachines/', variables('DC1vmName'))]"
          ],
          "tags": {
            "displayName": "FirstDC"
          },
          "properties": {
            "publisher": "Microsoft.Powershell",
            "type": "DSC",
            "typeHandlerVersion": "2.9",
            "autoUpgradeMinorVersion": true,
            "settings": {
              "modulesUrl": "[variables('adModulesURL')]",
              "configurationFunction": "[variables('FirstDCConfigurationFunction')]",
              "properties": {
                "DomainName": "[parameters('domainName')]",
                "ExchangeServerIP": "[variables('Exchange1ServerPrivateIP')]",
                "AdfsServerIP": "[variables('Adfs1ServerPrivateIP')]",
                "DnsDomainName": "[variables('DnsDomainName')]",
                "AdminCreds": {
                  "UserName": "[parameters('adminUsername')]",
                  "Password": "PrivateSettingsRef:AdminPassword"
                }
              }
            },
            "protectedSettings": {
              "Items": {
                "AdminPassword": "[parameters('adminPassword')]"
              }
            }
          }
        }
      ]
    },
      {
          "name": "[variables('Exchange1NicName')]",
          "type": "Microsoft.Network/networkInterfaces",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [
            "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]",
            "[concat('Microsoft.Network/publicIPAddresses/', variables('Exchange1PublicIPAddressName'))]",
            "[concat('Microsoft.Compute/virtualMachines/', variables('DC1vmName'))]"
          ],
          "tags": {
              "displayName": "Exchange1NIC"
          },
          "properties": {
              "ipConfigurations": [
                  {
                    "name": "ipconfig1",
                    "properties": {
                      "privateIPAddress": "[variables('Exchange1ServerPrivateIP')]",
                      "privateIPAllocationMethod": "Static",
                      "subnet": {
                        "id": "[variables('Exchange1SubnetRef')]"
                      },
                        "publicIPAddress": {
                            "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('Exchange1PublicIPAddressName'))]"
                        }
                    }
                  }
              ]
          }
      },
      {
          "name": "[parameters('Exchange1Name')]",
          "type": "Microsoft.Compute/virtualMachines",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [
              "[concat('Microsoft.Storage/storageAccounts/', variables('vhdStorageName'))]",
              "[concat('Microsoft.Network/networkInterfaces/', variables('Exchange1NicName'))]"
          ],
          "tags": {
              "displayName": "Exchange1"
          },
          "properties": {
              "hardwareProfile": {
                  "vmSize": "[variables('Exchange1VmSize')]"
              },
              "osProfile": {
                  "computerName": "[parameters('Exchange1Name')]",
                  "adminUsername": "[parameters('adminUsername')]",
                  "adminPassword": "[parameters('adminPassword')]"
              },
              "storageProfile": {
                  "imageReference": {
                      "publisher": "[variables('Exchange1ImagePublisher')]",
                      "offer": "[variables('Exchange1ImageOffer')]",
                      "sku": "[parameters('Exchange1WindowsOSVersion')]",
                      "version": "latest"
                  },
                  "osDisk": {
                      "name": "Exchange1OSDisk",
                      "vhd": {
                          "uri": "[concat('http://', variables('vhdStorageName'), '.blob.core.windows.net/', variables('Exchange1StorageAccountContainerName'), '/', variables('Exchange1OSDiskName'), '.vhd')]"
                      },
                      "caching": "ReadWrite",
                      "createOption": "FromImage"
                  }
              },
              "networkProfile": {
                  "networkInterfaces": [
                      {
                          "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('Exchange1NicName'))]"
                      }
                  ]
              }
          },
          "resources": [
              {
                  "name": "FirstExchangeServerARM",
                  "type": "extensions",
                  "location": "[resourceGroup().location]",
                  "apiVersion": "2015-06-15",
                  "dependsOn": [
                    "[concat('Microsoft.Compute/virtualMachines/', parameters('Exchange1Name'))]",
                    "[concat('Microsoft.Compute/virtualMachines/', variables('DC1vmName'),'/extensions/FirstDC')]"
                  ],
                  "tags": {
                      "displayName": "FirstExchangeServerARM"
                  },
                  "properties": {
                      "publisher": "Microsoft.Powershell",
                      "type": "DSC",
                      "typeHandlerVersion": "2.9",
                      "autoUpgradeMinorVersion": true,
                    "settings": {
                      "modulesUrl": "[variables('exchModulesURL')]",
                      "configurationFunction": "[variables('FirstExchangeServerARMConfigurationFunction')]",
                      "wmfVersion": "4.0",
                      "properties": {
                        "DomainName": "[parameters('domainName')]",
                        "ExchangeOrgName": "[parameters('ExchangeOrganizationName')]",
                        "SoftwareSourcePath": "[variables('exchSoftwareSourcePath')]",
                        "ServerName": "[parameters('Exchange1Name')]",
                        "CertPath": "[parameters('CertPath')]",
                        "CertThumbprint": "[parameters('ExchangeCertThumbprint')]",
                        "CertUri": "[parameters('CertUri')]",
                        "ExternalUrl": "[parameters('ExchangeExternalUrl')]",
                        "InternalUrl": "[parameters('ExchangeInternalUrl')]",
                        "AutoDDnsName": "[parameters('ExchangeAutoDDnsName')]",
                        "AdminCreds": {
                          "UserName": "[parameters('adminUsername')]",
                          "Password": "PrivateSettingsRef:AdminPassword"
                        }
                      }
                    },
                    "protectedSettings": {
                      "Items": {
                        "AdminPassword": "[parameters('adminPassword')]"
                      }
                    }
                  }
              }
              
          ]
      },
      {
          "name": "[variables('Exchange1PublicIPAddressName')]",
          "type": "Microsoft.Network/publicIPAddresses",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [ ],
          "tags": {
              "displayName": "Exchange1PublicIPAddress"
          },
          "properties": {
              "publicIPAllocationMethod": "Dynamic",
              "dnsSettings": {
                  "domainNameLabel": "[parameters('Exchange1PublicIPAddressDnsName')]"
              }
          }
      },
      {
          "name": "[variables('SQL1NicName')]",
          "type": "Microsoft.Network/networkInterfaces",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [
              "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]",
              "[concat('Microsoft.Network/publicIPAddresses/', variables('Sql1publicIPAddressName'))]"
          ],
          "tags": {
              "displayName": "SQL1Nic"
          },
          "properties": {
              "ipConfigurations": [
                  {
                      "name": "ipconfig1",
                    "properties": {
                      "privateIPAddress": "[variables('Sql1ServerPrivateIP')]",
                      "privateIPAllocationMethod": "Static",
                      "subnet": {
                        "id": "[variables('SQL1SubnetRef')]"
                      },
                        "publicIPAddress": {
                            "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('Sql1publicIPAddressName'))]"
                        }
                    }
                  }
              ]
          }
      },
      {
          "name": "[parameters('SQL1Name')]",
          "type": "Microsoft.Compute/virtualMachines",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [
              "[concat('Microsoft.Storage/storageAccounts/', variables('vhdStorageName'))]",
              "[concat('Microsoft.Network/networkInterfaces/', variables('SQL1NicName'))]"
          ],
          "tags": {
              "displayName": "SQL1"
          },
          "properties": {
              "hardwareProfile": {
                  "vmSize": "[variables('SQL1VmSize')]"
              },
            "osProfile": {
              "computerName": "[parameters('SQL1Name')]",
              "adminUsername": "[parameters('adminUsername')]",
              "adminPassword": "[parameters('adminPassword')]"
            },
              "storageProfile": {
                  "imageReference": {
                      "publisher": "[variables('SQL1ImagePublisher')]",
                      "offer": "[variables('SQL1ImageOffer')]",
                      "sku": "[parameters('SQL1WindowsOSVersion')]",
                      "version": "latest"
                  },
                  "osDisk": {
                      "name": "SQL1OSDisk",
                      "vhd": {
                          "uri": "[concat('http://', variables('vhdStorageName'), '.blob.core.windows.net/', variables('SQL1StorageAccountContainerName'), '/', variables('SQL1OSDiskName'), '.vhd')]"
                      },
                      "caching": "ReadWrite",
                      "createOption": "FromImage"
                  }
              },
              "networkProfile": {
                  "networkInterfaces": [
                      {
                          "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('SQL1NicName'))]"
                      }
                  ]
              }
          },
          "resources": [
              {
                  "name": "InstallSql",
                  "type": "extensions",
                  "location": "[resourceGroup().location]",
                  "apiVersion": "2015-06-15",
                "dependsOn": [
                  "[concat('Microsoft.Compute/virtualMachines/', parameters('SQL1Name'))]",
                  "[concat('Microsoft.Compute/virtualMachines/', variables('DC1vmName'),'/extensions/FirstDC')]"
                ],
                  "tags": {
                      "displayName": "InstallSql"
                  },
                  "properties": {
                      "publisher": "Microsoft.Powershell",
                      "type": "DSC",
                      "typeHandlerVersion": "2.9",
                      "autoUpgradeMinorVersion": true,
                      "settings": {
                          "modulesUrl": "[variables('sqlModulesURL')]",
                          "configurationFunction": "[variables('InstallSqlConfigurationFunction')]",
                        "properties": {
                          "DomainName": "[parameters('domainName')]",
                          "AdminCreds": {
                            "UserName": "[parameters('adminUsername')]",
                            "Password": "PrivateSettingsRef:AdminPassword"
                          }
                        }
                     },
                     "protectedSettings": {
                       "Items": {
                         "AdminPassword": "[parameters('adminPassword')]"
                       }
                    }
                 }
             }
          ]
      },
      {
          "name": "[variables('Adfs1NicName')]",
          "type": "Microsoft.Network/networkInterfaces",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [
              "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]",
              "[concat('Microsoft.Network/publicIPAddresses/', variables('Adfs1publicIPAddressName'))]"
          ],
          "tags": {
              "displayName": "Adfs1Nic"
          },
          "properties": {
              "ipConfigurations": [
                  {
                      "name": "ipconfig1",
                    "properties": {
                      "privateIPAddress": "[variables('Adfs1ServerPrivateIP')]",
                      "privateIPAllocationMethod": "Static",
                      "subnet": {
                        "id": "[variables('Adfs1SubnetRef')]"
                      },
                        "publicIPAddress": {
                            "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('Adfs1publicIPAddressName'))]"
                        }
                    }
                  }
              ]
          }
      },
      {
          "name": "[parameters('Adfs1Name')]",
          "type": "Microsoft.Compute/virtualMachines",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [
              "[concat('Microsoft.Storage/storageAccounts/', variables('vhdStorageName'))]",
              "[concat('Microsoft.Network/networkInterfaces/', variables('Adfs1NicName'))]"
          ],
          "tags": {
              "displayName": "Adfs1"
          },
          "properties": {
              "hardwareProfile": {
                  "vmSize": "[variables('Adfs1VmSize')]"
              },
            "osProfile": {
              "computerName": "[parameters('Adfs1Name')]",
              "adminUsername": "[parameters('adminUsername')]",
              "adminPassword": "[parameters('adminPassword')]"
            },
              "storageProfile": {
                  "imageReference": {
                      "publisher": "[variables('Adfs1ImagePublisher')]",
                      "offer": "[variables('Adfs1ImageOffer')]",
                      "sku": "[parameters('Adfs1WindowsOSVersion')]",
                      "version": "latest"
                  },
                  "osDisk": {
                      "name": "Adfs1OSDisk",
                      "vhd": {
                          "uri": "[concat('http://', variables('vhdStorageName'), '.blob.core.windows.net/', variables('Adfs1StorageAccountContainerName'), '/', variables('Adfs1OSDiskName'), '.vhd')]"
                      },
                      "caching": "ReadWrite",
                      "createOption": "FromImage"
                  }
              },
              "networkProfile": {
                  "networkInterfaces": [
                      {
                          "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('Adfs1NicName'))]"
                      }
                  ]
              }
          },
          "resources": [
              {
                  "name": "InstallAdfs",
                  "type": "extensions",
                  "location": "[resourceGroup().location]",
                  "apiVersion": "2015-06-15",
                "dependsOn": [
                  "[concat('Microsoft.Compute/virtualMachines/', parameters('Adfs1Name'))]",
                  "[concat('Microsoft.Compute/virtualMachines/', variables('DC1vmName'),'/extensions/FirstDC')]"
                ],
                  "tags": {
                      "displayName": "InstallAdfs"
                  },
                "properties": {
                  "publisher": "Microsoft.Powershell",
                  "type": "DSC",
                  "typeHandlerVersion": "2.9",
                  "autoUpgradeMinorVersion": true,
                  "settings": {
                    "modulesUrl": "[variables('adfsModulesURL')]",
                    "configurationFunction": "[variables('InstallAdfsConfigurationFunction')]",
                    "properties": {
                      "DomainName": "[parameters('domainName')]",
                      "CertPath": "[parameters('CertPath')]",
                      "CertThumbprint": "[parameters('ExchangeCertThumbprint')]",
                      "CertUri": "[parameters('CertUri')]",
                      "FedServiceName": "[parameters('AdfsFederationServiceName')]",
                      "FedServiceDisplayName": "[parameters('AdfsFederationServiceDisplayName')]",
                      "AdfsSrvActName": "[parameters('AdfsServiceAccountName')]",
                      "AdminCreds": {
                        "UserName": "[parameters('adminUsername')]",
                        "Password": "PrivateSettingsRef:AdminPassword"
                      }
                    }
                  },
                  "protectedSettings": {
                    "Items": {
                      "AdminPassword": "[parameters('adminPassword')]"
                    }
                  }
                }
              }
          ]
      },
      {
          "name": "[variables('Dirsync1NicName')]",
          "type": "Microsoft.Network/networkInterfaces",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [
              "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]",
              "[concat('Microsoft.Network/publicIPAddresses/', variables('Dirsync1publicIPAddressName'))]"
          ],
          "tags": {
              "displayName": "Dirsync1Nic"
          },
          "properties": {
              "ipConfigurations": [
                  {
                      "name": "ipconfig1",
                    "properties": {
                      "privateIPAddress": "[variables('Dirsync1ServerPrivateIP')]",
                      "privateIPAllocationMethod": "Static",
                      "subnet": {
                        "id": "[variables('Dirsync1SubnetRef')]"
                      },
                        "publicIPAddress": {
                            "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('Dirsync1publicIPAddressName'))]"
                        }
                    }
                  }
              ]
          }
      },
      {
          "name": "[parameters('Dirsync1Name')]",
          "type": "Microsoft.Compute/virtualMachines",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [
              "[concat('Microsoft.Storage/storageAccounts/', variables('vhdStorageName'))]",
              "[concat('Microsoft.Network/networkInterfaces/', variables('Dirsync1NicName'))]"
          ],
          "tags": {
              "displayName": "Dirsync1"
          },
          "properties": {
              "hardwareProfile": {
                  "vmSize": "[variables('Dirsync1VmSize')]"
              },
              "osProfile": {
                  "computerName": "[parameters('Dirsync1Name')]",
                  "adminUsername": "[parameters('adminUsername')]",
                  "adminPassword": "[parameters('adminPassword')]"
              },
              "storageProfile": {
                  "imageReference": {
                      "publisher": "[variables('Dirsync1ImagePublisher')]",
                      "offer": "[variables('Dirsync1ImageOffer')]",
                      "sku": "[parameters('Dirsync1WindowsOSVersion')]",
                      "version": "latest"
                  },
                  "osDisk": {
                      "name": "Dirsync1OSDisk",
                      "vhd": {
                          "uri": "[concat('http://', variables('vhdStorageName'), '.blob.core.windows.net/', variables('Dirsync1StorageAccountContainerName'), '/', variables('Dirsync1OSDiskName'), '.vhd')]"
                      },
                      "caching": "ReadWrite",
                      "createOption": "FromImage"
                  }
              },
              "networkProfile": {
                  "networkInterfaces": [
                      {
                          "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('Dirsync1NicName'))]"
                      }
                  ]
              }
          }
      },
      {
          "name": "[variables('Sql1publicIPAddressName')]",
          "type": "Microsoft.Network/publicIPAddresses",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [ ],
          "tags": {
              "displayName": "Sql1publicIPAddressName"
          },
          "properties": {
              "publicIPAllocationMethod": "Dynamic"
          }
      },
      {
          "name": "[variables('Wap1publicIPAddressName')]",
          "type": "Microsoft.Network/publicIPAddresses",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [ ],
          "tags": {
              "displayName": "Wap1publicIPAddressName"
          },
          "properties": {
              "publicIPAllocationMethod": "Dynamic",
              "dnsSettings": {
                  "domainNameLabel": "[parameters('Wap1publicIPAddressNameDnsName')]"
              }
          }
      },
      {
          "name": "[variables('Adfs1publicIPAddressName')]",
          "type": "Microsoft.Network/publicIPAddresses",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [ ],
          "tags": {
              "displayName": "Adfs1publicIPAddressName"
          },
          "properties": {
              "publicIPAllocationMethod": "Dynamic"
          }
      },
      {
          "name": "[variables('Dirsync1publicIPAddressName')]",
          "type": "Microsoft.Network/publicIPAddresses",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [ ],
          "tags": {
              "displayName": "Dirsync1publicIPAddressName"
          },
          "properties": {
              "publicIPAllocationMethod": "Dynamic"
          }
      },
      {
          "name": "[variables('WAP1NicName')]",
          "type": "Microsoft.Network/networkInterfaces",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [
            "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]",
            "[concat('Microsoft.Network/publicIPAddresses/', variables('Wap1publicIPAddressName'))]"
          ],
          "tags": {
              "displayName": "WAP1Nic"
          },
          "properties": {
              "ipConfigurations": [
                  {
                      "name": "ipconfig1",
                    "properties": {
                      "privateIPAddress": "[variables('Wap1ServerPrivateIP')]",
                      "privateIPAllocationMethod": "Static",
                      "subnet": {
                        "id": "[variables('WAP1SubnetRef')]"
                      },
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('Wap1publicIPAddressName'))]"
                      }
                    }
                  }
              ]
          }
      },
      {
          "name": "[parameters('WAP1Name')]",
          "type": "Microsoft.Compute/virtualMachines",
          "location": "[resourceGroup().location]",
          "apiVersion": "2015-06-15",
          "dependsOn": [
              "[concat('Microsoft.Storage/storageAccounts/', variables('vhdStorageName'))]",
              "[concat('Microsoft.Network/networkInterfaces/', variables('WAP1NicName'))]"
          ],
          "tags": {
              "displayName": "WAP1"
          },
          "properties": {
              "hardwareProfile": {
                  "vmSize": "[variables('WAP1VmSize')]"
              },
              "osProfile": {
                  "computerName": "[parameters('WAP1Name')]",
                  "adminUsername": "[parameters('adminUsername')]",
                  "adminPassword": "[parameters('adminPassword')]"
              },
              "storageProfile": {
                  "imageReference": {
                      "publisher": "[variables('WAP1ImagePublisher')]",
                      "offer": "[variables('WAP1ImageOffer')]",
                      "sku": "[parameters('WAP1WindowsOSVersion')]",
                      "version": "latest"
                  },
                  "osDisk": {
                      "name": "WAP1OSDisk",
                      "vhd": {
                          "uri": "[concat('http://', variables('vhdStorageName'), '.blob.core.windows.net/', variables('WAP1StorageAccountContainerName'), '/', variables('WAP1OSDiskName'), '.vhd')]"
                      },
                      "caching": "ReadWrite",
                      "createOption": "FromImage"
                  }
              },
              "networkProfile": {
                  "networkInterfaces": [
                      {
                          "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('WAP1NicName'))]"
                      }
                  ]
              }
          },
          "resources": [
              {
                  "name": "InstallWap",
                  "type": "extensions",
                  "location": "[resourceGroup().location]",
                  "apiVersion": "2015-06-15",
                "dependsOn": [
                  "[concat('Microsoft.Compute/virtualMachines/', parameters('WAP1Name'))]",
                  "[concat('Microsoft.Compute/virtualMachines/', variables('DC1vmName'),'/extensions/FirstDC')]",
                  "[concat('Microsoft.Compute/virtualMachines/', parameters('Adfs1Name'),'/extensions/InstallAdfs')]"
                ],
                  "tags": {
                      "displayName": "InstallWap"
                  },
                  "properties": {
                      "publisher": "Microsoft.Powershell",
                      "type": "DSC",
                      "typeHandlerVersion": "2.9",
                      "autoUpgradeMinorVersion": true,
                      "settings": {
                          "modulesUrl": "[variables('wapModulesURL')]",
                          "configurationFunction": "[variables('InstallWapConfigurationFunction')]",
                        "properties": {
                          "DomainName": "[parameters('domainName')]",
                          "CertPath": "[parameters('CertPath')]",
                          "CertThumbprint": "[parameters('ExchangeCertThumbprint')]",
                          "CertUri": "[parameters('CertUri')]",
                          "FedServiceName": "[parameters('AdfsFederationServiceName')]",
                          "AdminCreds": {
                            "UserName": "[parameters('adminUsername')]",
                            "Password": "PrivateSettingsRef:AdminPassword"
                          }
                        }
                      },
                    "protectedSettings": {
                      "Items": {
                        "AdminPassword": "[parameters('adminPassword')]"
                      }
                    }
                  }
              }
          ]
      }
  ]
}
